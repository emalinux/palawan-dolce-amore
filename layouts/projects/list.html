{{ define "main" }}

{{ if .Params.year }}
  <!-- PAGINA ANNO (es. /projects/2019/) -->
  <div class="page-container projects-year-page">

    <h1>{{ .Title }}</h1>

    {{ with .Params.description }}
      <p class="projects-year-intro">{{ . }}</p>
    {{ end }}

    <!-- Slider -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <div class="projects-slider-wrapper">
      <div class="swiper mySwiper">
        <div class="swiper-wrapper">
          {{ range .Params.featuredPhotos }}
          <div class="swiper-slide">
            <img src="{{ . }}" />
          </div>
          {{ end }}
        </div>

        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
      new Swiper(".mySwiper", {
        loop: true,
        speed: 600,
        autoplay: {
          delay: 4000,
          disableOnInteraction: false,
        },
        pagination: { el: ".swiper-pagination", clickable: true },
        navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
      });
    </script>

    <hr style="margin: 30px 0;" />

    <!-- GALLERY CON LAZYLOAD + INFINITE SCROLL -->
    <h2 class="projects-gallery-title">Full photo gallery</h2>

    {{ $dir := .Params.galleryDir }}
    {{ $page := . }}
    {{ if $dir }}
      <div class="projects-gallery" id="projects-gallery">
        {{ range readDir (printf "static%s" $dir) }}
          {{ if not .IsDir }}
            {{ $img := printf "%s%s" $dir .Name }}
            <a href="{{ $img }}" class="glightbox gallery-item" data-gallery="year-{{ $page.Params.year }}">
              <img src="{{ $img }}" alt="" loading="lazy" />
            </a>
          {{ end }}
        {{ end }}
      </div>
      <div id="gallery-sentinel"></div>
    {{ else }}
      <p class="projects-gallery-empty">No gallery configured for this year yet.</p>
    {{ end }}

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var gallery = document.getElementById("projects-gallery");
        if (!gallery) return;

        var items = Array.prototype.slice.call(gallery.querySelectorAll(".gallery-item"));
        if (!items.length) return;

        var batchSize = 40;   // quante foto per blocco
        var shown = 0;

        // nascondi tutto all'inizio
        items.forEach(function (item) {
          item.classList.add("is-hidden");
        });

        function showNextBatch() {
          var next = shown + batchSize;
          for (var i = shown; i < next && i < items.length; i++) {
            items[i].classList.remove("is-hidden");
            items[i].classList.add("is-visible");
          }
          shown = next;
          if (shown >= items.length && sentinel) {
            if (observer) observer.disconnect();
            if (sentinel.parentNode) sentinel.parentNode.removeChild(sentinel);
          }
        }

        var sentinel = document.getElementById("gallery-sentinel");
        var observer = null;

        if ("IntersectionObserver" in window && sentinel) {
          observer = new IntersectionObserver(function (entries) {
            entries.forEach(function (entry) {
              if (entry.isIntersecting) {
                showNextBatch();
              }
            });
          });
          observer.observe(sentinel);
        } else {
          // fallback: se il browser Ã¨ vecchio, mostra tutto
          items.forEach(function (item) {
            item.classList.remove("is-hidden");
          });
        }

        // primo blocco subito visibile
        showNextBatch();
      });
    </script>

  </div>

{{ else }}
  <!-- PAGINA ROOT /projects/ -->
  <div class="page-container projects-list-page">
    <h1>Projects by year</h1>

    <ul class="projects-year-list">
      {{ range .Pages.ByParam "year" }}
        <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
      {{ end }}
    </ul>
  </div>
{{ end }}

{{ end }}